---
redirect_from:
  - "/features/notebooks/hiddensemimarkovmodel"
interact_link: content/features/notebooks/HiddenSemiMarkovModel.ipynb
kernel_name: ir
kernel_path: content/features/notebooks
has_widgets: false
title: |-
  Hidden Semi-Markov Models
pagenum: 12
prev_page:
  url: /features/notebooks/timecorr.html
next_page:
  url: /features/notebooks/Pliers_Tutorial.html
suffix: .ipynb
search: state data model r states sojourn subject distribution fit tutorial need using lets connectivity where package part series mean into analysis matrix parameters files hidden covariance probability run functional markov models brain also take please p read transition semi nodes fc fmri rois correlation estimate length similar hsmms hsmm sherlock software code packages etc mhsmm jared oconnell times initialize results plot dynamic shappell regions between interest structure standard consecutive points subjects same specify gamma next install installed should x before folder initial matrices above want written heather networks system created relationship individual pre analyses patterns groups studies approach context via

comment: "***PROGRAMMATICALLY GENERATED, DO NOT EDIT. SEE ORIGINAL FILES IN /content***"
---

    <main class="jupyter-page">
    <div id="page-info"><div id="page-title">Hidden Semi-Markov Models</div>
</div>
    <div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Dynamic-Functional-Connectivity-Analysis-Using-Hidden-Semi-Markov--Models">Dynamic Functional Connectivity Analysis Using Hidden Semi-Markov  Models<a class="anchor-link" href="#Dynamic-Functional-Connectivity-Analysis-Using-Hidden-Semi-Markov--Models"> </a></h1><p><em>Written by Heather Shappell</em></p>
<h1 id="Overview">Overview<a class="anchor-link" href="#Overview"> </a></h1><p>The study of functional brain networks, where the brain is viewed as a system of interacting regions (nodes/vertices) that produce complex behaviors, has grown rapidly over the past decade. Brain networks can be created by performing a functional connectivity (FC) analysis, where the strength of the relationship between nodes is evaluated using the fMRI time series associated with each node. The nodes can consist of individual voxels, pre-specified regions of interest (ROIs), or sets of regions estimated using independent component analysis (ICA). The relationship between nodes is quantified using a variety of metrics, with the most common being Pearon or partial correlation coefficients.</p>
<p>While most FC analyses estimate one static, average network for the entire length of the fMRI time series, there is increased interest in studying time-varying changes in FC. In other words, researchers are interested in investigating the patterns of state traversal in individuals and comparing these patterns across subject groups in both resting-state fMRI studies and task-based fMRI studies.</p>
<p>In recent years, Hidden Markov models (HMMs) have proven to be a useful modeling approach towards assessing FC. In this context, it is assumed that the time series data at each brain region can be described via a series of a fixed number of hidden/unknown brain states. Each state is characterized by a multivariate Gaussian distribution, which is parameterized by the mean and covariance. Of particular interest is the unique connectivity structure of each state, encapsulated within the covariance matrix.</p>
<p>A limitation of the standard HMM approach is that the sojourn time, the number of consecutive time points spent in a specific state, is geometrically distributed. A property of the geometric distribution is that the probability decreases as the sojourn time increases. Therefore, more weight is placed on shorter consecutive time points in a given state. This may not be appropriate in the context of functional connectivity analysis, as it suggests subjects are switching states very often, as opposed to potentially spending longer periods of time in the same state. It also suggests that the sojourn time for all states follow a very similar pattern, which may not be the case in practice.</p>
<p>A possible solution to this issue, if it is of concern to the researcher, is to explicitly model and estimate the sojourn distribution via Hidden semi-Markov models (HSMMs). HSMMs differ from the standard HMM in that the sojourn distribution is explicitly built into the likelihood function. One may specify the distribution to take a nonparametric form or a parametric form (such as a Poisson or Gamma distribution) and estimate the parameters directly.</p>
<p>In this tutorial, we will demonstrate how to fit the HSMM in R and view the resulting output on the Sherlock video data set. For more information on using HSMMs for dynamic connectivity analysis, please refer to:</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Software">Software<a class="anchor-link" href="#Software"> </a></h1><p>This tutorial is slightly different from the previous tutorials in that it uses R instead of Python. This tutorial will use an R kernel, so make sure you select this or you will be unable to run the code. Please follow the instructions for installing R and connecting it to a Jupyter Notebook in the <a href="http://naturalistic-data.org/features/notebooks/Software.html#R">Software Installation</a> tutorial.</p>
<p>Next we need to install the R packages we will need to run this tutorial.</p>
<p>Note: you only need to run this cell once. No need to run it again after the packages are installed.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;MASS&quot;</span><span class="p">)</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;distr&quot;</span><span class="p">)</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;mvtnorm&quot;</span><span class="p">)</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;mhsmm&quot;</span><span class="p">)</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;gplots&quot;</span><span class="p">)</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;rasterVis&quot;</span><span class="p">)</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;lattice&quot;</span><span class="p">)</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;shapes&quot;</span><span class="p">)</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;remotes&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Note that the package <code>mvnmle</code> is no longer maintained and cannot be installed using the normal package management system. We can install older versions or <em>orphaned</em> libraries using the <code>remotes</code> package.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">remotes</span><span class="p">)</span>
<span class="nf">install_version</span><span class="p">(</span><span class="s">&quot;mvnmle&quot;</span><span class="p">,</span> <span class="s">&quot;0.1-11.1&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Downloading package from url: https://cran.r-project.org/src/contrib/Archive/mvnmle/mvnmle_0.1-11.1.tar.gz

</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Ok, now that we have installed the packages we will be using, we now need to import them into our environment. This is conceptually similar to loading the Python modules we use in each tutorial.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">MASS</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">distr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">mvnmle</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">mvtnorm</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">mhsmm</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">gplots</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">rasterVis</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">lattice</span><span class="p">)</span> 
<span class="nf">library</span><span class="p">(</span><span class="n">shapes</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Loading required package: startupmsg

Utilities for Start-Up Messages (version 0.9.6)

For more information see ?&#34;startupmsg&#34;, NEWS(&#34;startupmsg&#34;)


Loading required package: sfsmisc

Object Oriented Implementation of Distributions (version 2.8.0)

Attention: Arithmetics on distribution objects are understood as operations on corresponding random variables (r.v.s); see distrARITH().
Some functions from package &#39;stats&#39; are intentionally masked ---see distrMASK().
Note that global options are controlled by distroptions() ---c.f. ?&#34;distroptions&#34;.

For more information see ?&#34;distr&#34;, NEWS(&#34;distr&#34;), as well as
  http://distr.r-forge.r-project.org/
Package &#34;distrDoc&#34; provides a vignette to this package as well as to several extension packages; try vignette(&#34;distr&#34;).



Attaching package: ‘distr’


The following objects are masked from ‘package:stats’:

    df, qqplot, sd



Attaching package: ‘gplots’


The following object is masked from ‘package:stats’:

    lowess


Loading required package: raster

Loading required package: sp


Attaching package: ‘raster’


The following objects are masked from ‘package:MASS’:

    area, select


Loading required package: lattice

Loading required package: latticeExtra

</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Data-Preparation">Data Preparation<a class="anchor-link" href="#Data-Preparation"> </a></h1><p>Prior to running the HSMM analysis, your data should be pre-processed and organized into subject files where the data is organized as a T x P matrix, where T is the length of the time series and P is the number of ROIs you wish to include in the connectivity analysis. All subject files should contain the same number of ROIs, but the time series lengths may differ by subject.</p>
<p>This tutorial will utilize the Sherlock data subject files, where each participant has two files - part 1 and part 2. There are 16 participants.</p>
<p>Let's read the files into R, but before we get started with reading in the data, we need to install and load the R packages we will need for this tutorial.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, we will read the data into R. The Sherlock subject files should be saved to their own folder, with no other files in the folder. Specify the current directory of the folder, and read in the data as follows. This code will concatenate the subject data into one data frame, where the data from subject one (part 1 and 2) will appear first, followed by subject two (part 1 and 2), etc...</p>
<p>First, we need to set the path, so that R knows where to search for the data. Change <code>setwd("&lt;to path of Sherlock dataset&gt;")</code>.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="c1">#Set the working directory.</span>
<span class="nf">setwd</span><span class="p">(</span><span class="s">&quot;/Volumes/Engram/Data/Sherlock&quot;</span><span class="p">)</span>

<span class="c1">#Get names of subject files in the folder.</span>
<span class="n">filenames</span> <span class="o">&lt;-</span> <span class="nf">Sys.glob</span><span class="p">(</span><span class="nf">file.path</span><span class="p">(</span><span class="nf">getwd</span><span class="p">(),</span> <span class="s">&#39;fmriprep&#39;</span><span class="p">,</span><span class="s">&#39;*&#39;</span><span class="p">,</span><span class="s">&#39;func&#39;</span><span class="p">,</span><span class="s">&#39;sub*Average_ROI_n50.csv&#39;</span><span class="p">))</span>

<span class="c1">#View the subject file names to ensure they have read in correctly.</span>
<span class="n">filenames</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-01/func/sub-01_Part1_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-01/func/sub-01_Part2_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-02/func/sub-02_Part1_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-02/func/sub-02_Part2_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-03/func/sub-03_Part1_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-03/func/sub-03_Part2_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-04/func/sub-04_Part1_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-04/func/sub-04_Part2_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-05/func/sub-05_Part1_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-05/func/sub-05_Part2_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-06/func/sub-06_Part1_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-06/func/sub-06_Part2_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-07/func/sub-07_Part1_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-07/func/sub-07_Part2_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-08/func/sub-08_Part1_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-08/func/sub-08_Part2_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-09/func/sub-09_Part1_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-09/func/sub-09_Part2_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-10/func/sub-10_Part1_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-10/func/sub-10_Part2_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-11/func/sub-11_Part1_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-11/func/sub-11_Part2_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-12/func/sub-12_Part1_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-12/func/sub-12_Part2_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-13/func/sub-13_Part1_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-13/func/sub-13_Part2_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-14/func/sub-14_Part1_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-14/func/sub-14_Part2_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-15/func/sub-15_Part1_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-15/func/sub-15_Part2_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-16/func/sub-16_Part1_Average_ROI_n50.csv'</li><li>'/Volumes/Engram/Data/Sherlock/fmriprep/sub-16/func/sub-16_Part2_Average_ROI_n50.csv'</li></ol>

</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Loop through each file name to read it in, and center and scale data so that each column (ROI) has a mean of 0 and a standard deviation of 1.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">DataReadIn</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span><span class="nf">function</span><span class="p">(</span><span class="n">i</span><span class="p">){</span>
  <span class="n">table</span><span class="o">&lt;-</span><span class="nf">read.csv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span> <span class="n">row.names</span><span class="o">=</span><span class="kc">NULL</span><span class="p">)</span>
  <span class="n">table</span><span class="o">&lt;-</span><span class="nf">scale</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
  <span class="nf">return</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
<span class="p">})</span>

<span class="n">DataFinal</span><span class="o">&lt;-</span><span class="nf">do.call</span><span class="p">(</span><span class="n">rbind</span><span class="p">,</span> <span class="n">DataReadIn</span><span class="p">)</span>
<span class="n">DataFinal</span><span class="o">&lt;-</span><span class="nf">as.data.frame</span><span class="p">(</span><span class="n">DataFinal</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's also grab the time series length for every file we have read in and save this informatiom.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">TimeSerLen</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span><span class="nf">function</span><span class="p">(</span><span class="n">i</span><span class="p">){</span>
  <span class="n">table</span><span class="o">&lt;-</span><span class="nf">read.csv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span> <span class="n">row.names</span><span class="o">=</span><span class="kc">NULL</span><span class="p">)</span>
  <span class="n">Nrows</span><span class="o">&lt;-</span><span class="nf">nrow</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
  <span class="nf">return</span><span class="p">(</span><span class="n">Nrows</span><span class="p">)</span>
<span class="p">})</span>

<span class="n">Lengths</span><span class="o">&lt;-</span><span class="nf">do.call</span><span class="p">(</span><span class="n">rbind</span><span class="p">,</span> <span class="n">TimeSerLen</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Model-Parameter-Initialization-and-Model-Specification">Model Parameter Initialization and Model Specification<a class="anchor-link" href="#Model-Parameter-Initialization-and-Model-Specification"> </a></h1><p>Now, we need to initilize the HSMM model parameters. These parameters are</p>
<ul>
<li>One P x P covariance matrix and a  1 x P  mean vector for each state.</li>
<li>A state transition probability matrix.</li>
<li>An initial state probability matrix.</li>
<li>Sojourn distribution parameters for each state (this will depend on which sojourn distribution you would like to fit).</li>
</ul>
<p>The R package that we are using to fit the model is the MHSMM R package, created by Jared O’Connell, et al. For a more in debt review of this package, please see:</p>

<pre><code>O’Connell, Jared, and Søren Højsgaard. "Hidden semi markov models for multiple observation sequences: The mhsmm package for R." Journal of Statistical Software 39.4 (2011): 1-22.

</code></pre>
<p>and</p>

<pre><code>O'Connell, Jared, Søren Højsgaard, and Maintainer Jared O'Connell. "Package ‘mhsmm’." CRAN (2017): 16.

</code></pre>
<h2 id="Number-of-states">Number of states<a class="anchor-link" href="#Number-of-states"> </a></h2><p>Before fitting the model, one needs to decide how many states to fit. The model can ultimately be fit several times, for several numbers of states. The number of states you choose to fit is largely driven by the number of subjects you have, the length of the time series, the number of ROIs you are working with, etc. For the purpose of this tutorial, we will fit the data to 4 states.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="c1">#Let&#39;s specify the number of states we wish to fit</span>
<span class="n">number_states</span> <span class="o">=</span> <span class="m">4</span>

<span class="c1">#Let&#39;s also create a variable for the number of scans (i.e. two for each subject) and the number of ROIs</span>
<span class="n">number_runs</span> <span class="o">&lt;-</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">Lengths</span><span class="p">)</span>
<span class="n">number_regions</span> <span class="o">&lt;-</span> <span class="nf">ncol</span><span class="p">(</span><span class="n">DataFinal</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Mean-and-Covariance">Mean and Covariance<a class="anchor-link" href="#Mean-and-Covariance"> </a></h2><p>We need to initialize mean and covariance matrices for <em>each</em> state because the model needs a starting point.</p>
<p>To do this, we will divide most of the data into sections that equal the number of states the model is fitting 
and then, we will find the mean and covariance for each state. Again, this is just a rough estimate for the estimation 
routine to have a place to begin, so there are many options for how you choose to initialize your model parameters.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="c1">#First, let&#39;s divide the data into sections. </span>
<span class="n">output_array</span> <span class="o">=</span> <span class="nf">list</span><span class="p">()</span>
<span class="n">seglength</span> <span class="o">&lt;-</span> <span class="nf">ceiling</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">Lengths</span><span class="p">[,</span><span class="m">1</span><span class="p">])</span><span class="o">/</span><span class="n">number_states</span><span class="p">)</span>

<span class="nf">for</span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="n">number_states</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">output_array</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span><span class="n">nrow</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">number_regions</span><span class="p">)</span>
  <span class="nf">colnames</span><span class="p">(</span><span class="n">output_array</span><span class="p">[[</span><span class="n">i</span><span class="p">]])</span> <span class="o">&lt;-</span> <span class="nf">colnames</span><span class="p">(</span><span class="n">DataFinal</span><span class="p">)</span>
  <span class="nf">for</span><span class="p">(</span><span class="n">j</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="n">number_runs</span><span class="p">){</span>
    <span class="n">output_array</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="nf">rbind</span><span class="p">(</span><span class="n">output_array</span><span class="p">[[</span><span class="n">i</span><span class="p">]],</span><span class="n">DataFinal</span><span class="p">[(</span><span class="m">1</span><span class="o">+</span><span class="nf">sum</span><span class="p">(</span><span class="n">Lengths</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="p">(</span><span class="n">j</span><span class="m">-1</span><span class="p">),</span><span class="m">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">seglength</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="m">-1</span><span class="p">))</span><span class="o">:</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">Lengths</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="p">(</span><span class="n">j</span><span class="m">-1</span><span class="p">),</span> <span class="m">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">seglength</span><span class="o">*</span><span class="n">i</span><span class="p">),])</span>
  <span class="p">}</span>
  <span class="n">output_array</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="n">output_array</span><span class="p">[[</span><span class="n">i</span><span class="p">]][</span><span class="m">-1</span><span class="p">,]</span>
<span class="p">}</span>

<span class="c1">#Now find mean and covariance for each section.</span>
<span class="n">MeanEst</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="n">output_array</span><span class="p">,</span><span class="nf">function</span><span class="p">(</span><span class="n">i</span><span class="p">){</span>
  <span class="n">means</span> <span class="o">&lt;-</span> <span class="nf">mlest</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">$</span><span class="n">muhat</span>
  <span class="nf">return</span><span class="p">(</span><span class="n">means</span><span class="p">)</span>
<span class="p">})</span>

<span class="n">CovEst</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="n">output_array</span><span class="p">,</span><span class="nf">function</span><span class="p">(</span><span class="n">i</span><span class="p">){</span>
  <span class="n">covs</span> <span class="o">&lt;-</span> <span class="nf">mlest</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">$</span><span class="n">sigmahat</span>
  <span class="nf">return</span><span class="p">(</span><span class="n">covs</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Warning message in mysort(data):
“NAs introduced by coercion to integer range”
Warning message in mysort(data):
“NAs introduced by coercion to integer range”
Warning message in mysort(data):
“NAs introduced by coercion to integer range”
Warning message in mysort(data):
“NAs introduced by coercion to integer range”
Warning message in mysort(data):
“NAs introduced by coercion to integer range”
Warning message in mysort(data):
“NAs introduced by coercion to integer range”
Warning message in mysort(data):
“NAs introduced by coercion to integer range”
Warning message in mysort(data):
“NAs introduced by coercion to integer range”
</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Now-we-will-initialize-the-transition-probability-parameters.">Now we will initialize the transition probability parameters.<a class="anchor-link" href="#Now-we-will-initialize-the-transition-probability-parameters."> </a></h2><p>These are initial state probabilities for the algorithm. We will make them all uniform unless we have prior beliefs for what they may be.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">initial</span> <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="n">number_states</span><span class="p">,</span> <span class="n">number_states</span><span class="p">)</span>

<span class="c1">#This initializes a state transition probability matrix. Again, we will make these uniform.</span>
<span class="n">TransMatrix</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="n">number_states</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">number_states</span><span class="p">)</span>
<span class="nf">diag</span><span class="p">(</span><span class="n">TransMatrix</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="m">0</span>
<span class="n">TransMatrix</span><span class="p">[</span><span class="nf">is.na</span><span class="p">(</span><span class="n">TransMatrix</span><span class="p">)]</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="p">(</span><span class="n">number_states</span><span class="m">-1</span><span class="p">))</span>

<span class="c1">##This saves the initial mean and covariances to a list, which is what will be needed to fit the model.</span>
<span class="n">b</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">(</span><span class="n">mu</span> <span class="o">=</span> <span class="n">MeanEst</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">CovEst</span><span class="p">)</span>

<span class="c1">##This puts the data into a list to fit the model.</span>
<span class="n">Datanew</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">DataFinal</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">Lengths</span><span class="p">[,</span><span class="m">1</span><span class="p">])</span>
<span class="nf">class</span><span class="p">(</span><span class="n">Datanew</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="s">&quot;hmm.data&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Lastly, we need to specify a sojourn distribution family (Gamma, Poisson, non-parametric, etc.) that we would like to fit, along with some initial estimates for the distribution parameters. Please refer to the above MHSMM package references for a complete list of sojourn distributions one may fit. For this tutorial, we will fit a Gamma distribution to each state. We randomly sample a shape and size parameter for each state to initialize the distribution.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">d</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">(</span><span class="n">shape</span> <span class="o">=</span> <span class="nf">sample</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">number_states</span><span class="p">),</span> <span class="n">scale</span> <span class="o">=</span> <span class="nf">sample</span><span class="p">(</span><span class="m">10</span><span class="o">:</span><span class="m">50</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">number_states</span><span class="p">),</span> <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;gamma&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now it is time to define the model and run it! The running of the model may take 10-15 minutes, so please be patient. :-)</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">model1</span> <span class="o">&lt;-</span> <span class="nf">hsmmspec</span><span class="p">(</span><span class="n">init</span> <span class="o">=</span> <span class="n">initial</span><span class="p">,</span> <span class="n">trans</span> <span class="o">=</span> <span class="n">TransMatrix</span><span class="p">,</span> <span class="n">parms.emis</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">dens.emis</span> <span class="o">=</span> <span class="n">dmvnorm.hsmm</span><span class="p">,</span> <span class="n">sojourn</span> <span class="o">=</span> <span class="n">d</span><span class="p">)</span>

<span class="n">testrun</span> <span class="o">&lt;-</span> <span class="nf">hsmmfit</span><span class="p">(</span><span class="n">Datanew</span><span class="p">,</span> <span class="n">model1</span><span class="p">,</span> <span class="n">mstep</span><span class="o">=</span><span class="n">mstep.mvnorm</span><span class="p">,</span> <span class="n">lock.transition</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">maxit</span><span class="o">=</span><span class="m">1000</span><span class="p">,</span> <span class="n">lock.d</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Model-Results">Model Results<a class="anchor-link" href="#Model-Results"> </a></h1>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now let's take a look at the model results! All of the results are saved in the testrun object. Let's first take a look at the correlation structure (i.e. our connectivity matrix) for each state!</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="c1">#Let&#39;s visualize the states correlation matrices.</span>
<span class="n">cov1</span><span class="o">&lt;-</span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">testrun</span><span class="o">$</span><span class="n">model</span><span class="o">$</span><span class="n">parms.emission</span><span class="o">$</span><span class="n">sigma</span><span class="p">[[</span><span class="m">1</span><span class="p">]])</span>
<span class="n">cov2</span><span class="o">&lt;-</span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">testrun</span><span class="o">$</span><span class="n">model</span><span class="o">$</span><span class="n">parms.emission</span><span class="o">$</span><span class="n">sigma</span><span class="p">[[</span><span class="m">2</span><span class="p">]])</span>
<span class="n">cov3</span><span class="o">&lt;-</span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">testrun</span><span class="o">$</span><span class="n">model</span><span class="o">$</span><span class="n">parms.emission</span><span class="o">$</span><span class="n">sigma</span><span class="p">[[</span><span class="m">3</span><span class="p">]])</span>
<span class="n">cov4</span><span class="o">&lt;-</span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">testrun</span><span class="o">$</span><span class="n">model</span><span class="o">$</span><span class="n">parms.emission</span><span class="o">$</span><span class="n">sigma</span><span class="p">[[</span><span class="m">4</span><span class="p">]])</span>

<span class="c1">#Convert the covariance matrices to correlation matrices.</span>
<span class="n">Cor1</span><span class="o">&lt;-</span><span class="nf">cov2cor</span><span class="p">(</span><span class="n">cov1</span><span class="p">)</span>
<span class="n">Cor2</span><span class="o">&lt;-</span><span class="nf">cov2cor</span><span class="p">(</span><span class="n">cov2</span><span class="p">)</span>
<span class="n">Cor3</span><span class="o">&lt;-</span><span class="nf">cov2cor</span><span class="p">(</span><span class="n">cov3</span><span class="p">)</span>
<span class="n">Cor4</span><span class="o">&lt;-</span><span class="nf">cov2cor</span><span class="p">(</span><span class="n">cov4</span><span class="p">)</span>

<span class="c1">#Set the color theme for the state plots we are about to make.</span>
<span class="n">my.theme</span> <span class="o">&lt;-</span> <span class="nf">BuRdTheme</span><span class="p">()</span>
<span class="n">my.at</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">-1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="n">length.out</span><span class="o">=</span><span class="nf">length</span><span class="p">(</span><span class="n">my.theme</span><span class="o">$</span><span class="n">regions</span><span class="o">$</span><span class="n">col</span><span class="p">)</span><span class="m">-1</span><span class="p">)</span>
<span class="n">my.ckey</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">(</span><span class="n">at</span><span class="o">=</span><span class="n">my.at</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">my.theme</span><span class="o">$</span><span class="n">regions</span><span class="o">$</span><span class="n">col</span><span class="p">)</span>

<span class="c1">#After running this code, the states should display as images in R.</span>
<span class="nf">levelplot</span><span class="p">(</span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">Cor1</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="nf">ncol</span><span class="p">(</span><span class="n">Cor1</span><span class="p">),</span><span class="nf">ncol</span><span class="p">(</span><span class="n">Cor1</span><span class="p">)</span><span class="o">:</span><span class="m">1</span><span class="p">]),</span> <span class="n">par.settings</span><span class="o">=</span><span class="n">my.theme</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="n">my.at</span><span class="p">,</span> <span class="n">colorkey</span><span class="o">=</span><span class="n">my.ckey</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">rot</span><span class="o">=</span><span class="m">90</span><span class="p">)),</span> <span class="n">main</span><span class="o">=</span><span class="s">&quot;State 1&quot;</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;ROI&quot;</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;ROI&quot;</span><span class="p">)</span>
<span class="nf">levelplot</span><span class="p">(</span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">Cor2</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="nf">ncol</span><span class="p">(</span><span class="n">Cor2</span><span class="p">),</span><span class="nf">ncol</span><span class="p">(</span><span class="n">Cor2</span><span class="p">)</span><span class="o">:</span><span class="m">1</span><span class="p">]),</span> <span class="n">par.settings</span><span class="o">=</span><span class="n">my.theme</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="n">my.at</span><span class="p">,</span> <span class="n">colorkey</span><span class="o">=</span><span class="n">my.ckey</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">rot</span><span class="o">=</span><span class="m">90</span><span class="p">)),</span> <span class="n">main</span><span class="o">=</span><span class="s">&quot;State 2&quot;</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;ROI&quot;</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;ROI&quot;</span><span class="p">)</span>
<span class="nf">levelplot</span><span class="p">(</span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">Cor3</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="nf">ncol</span><span class="p">(</span><span class="n">Cor3</span><span class="p">),</span><span class="nf">ncol</span><span class="p">(</span><span class="n">Cor3</span><span class="p">)</span><span class="o">:</span><span class="m">1</span><span class="p">]),</span> <span class="n">par.settings</span><span class="o">=</span><span class="n">my.theme</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="n">my.at</span><span class="p">,</span> <span class="n">colorkey</span><span class="o">=</span><span class="n">my.ckey</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">rot</span><span class="o">=</span><span class="m">90</span><span class="p">)),</span> <span class="n">main</span><span class="o">=</span><span class="s">&quot;State 3&quot;</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;ROI&quot;</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;ROI&quot;</span><span class="p">)</span>
<span class="nf">levelplot</span><span class="p">(</span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">Cor4</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="nf">ncol</span><span class="p">(</span><span class="n">Cor4</span><span class="p">),</span><span class="nf">ncol</span><span class="p">(</span><span class="n">Cor4</span><span class="p">)</span><span class="o">:</span><span class="m">1</span><span class="p">]),</span> <span class="n">par.settings</span><span class="o">=</span><span class="n">my.theme</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="n">my.at</span><span class="p">,</span> <span class="n">colorkey</span><span class="o">=</span><span class="n">my.ckey</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">rot</span><span class="o">=</span><span class="m">90</span><span class="p">)),</span> <span class="n">main</span><span class="o">=</span><span class="s">&quot;State 4&quot;</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;ROI&quot;</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;ROI&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../../images/features/notebooks/HiddenSemiMarkovModel_26_0.png"
width=420
height=420
>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../../images/features/notebooks/HiddenSemiMarkovModel_26_1.png"
width=420
height=420
>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../../images/features/notebooks/HiddenSemiMarkovModel_26_2.png"
width=420
height=420
>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../../images/features/notebooks/HiddenSemiMarkovModel_26_3.png"
width=420
height=420
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can also look at the mean activation for each state by checking out the mean vectors for each state!</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">mean1</span><span class="o">&lt;-</span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">testrun</span><span class="o">$</span><span class="n">model</span><span class="o">$</span><span class="n">parms.emission</span><span class="o">$</span><span class="n">mu</span><span class="p">[[</span><span class="m">1</span><span class="p">]])</span>
<span class="n">mean2</span><span class="o">&lt;-</span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">testrun</span><span class="o">$</span><span class="n">model</span><span class="o">$</span><span class="n">parms.emission</span><span class="o">$</span><span class="n">mu</span><span class="p">[[</span><span class="m">2</span><span class="p">]])</span>
<span class="n">mean3</span><span class="o">&lt;-</span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">testrun</span><span class="o">$</span><span class="n">model</span><span class="o">$</span><span class="n">parms.emission</span><span class="o">$</span><span class="n">mu</span><span class="p">[[</span><span class="m">3</span><span class="p">]])</span>
<span class="n">mean4</span><span class="o">&lt;-</span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">testrun</span><span class="o">$</span><span class="n">model</span><span class="o">$</span><span class="n">parms.emission</span><span class="o">$</span><span class="n">mu</span><span class="p">[[</span><span class="m">4</span><span class="p">]])</span>

<span class="n">my.theme</span> <span class="o">&lt;-</span> <span class="nf">BuRdTheme</span><span class="p">()</span>
<span class="n">my.at</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="nf">as.matrix</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="nf">cbind</span><span class="p">(</span><span class="n">mean1</span><span class="p">,</span><span class="n">mean2</span><span class="p">,</span><span class="n">mean3</span><span class="p">,</span><span class="n">mean4</span><span class="p">)))),</span><span class="nf">max</span><span class="p">(</span><span class="nf">as.matrix</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="nf">cbind</span><span class="p">(</span><span class="n">mean1</span><span class="p">,</span><span class="n">mean2</span><span class="p">,</span><span class="n">mean3</span><span class="p">,</span><span class="n">mean4</span><span class="p">)))),</span><span class="n">length.out</span><span class="o">=</span><span class="nf">length</span><span class="p">(</span><span class="n">my.theme</span><span class="o">$</span><span class="n">regions</span><span class="o">$</span><span class="n">col</span><span class="p">)</span><span class="m">-1</span><span class="p">)</span>
<span class="n">my.ckey</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">(</span><span class="n">at</span><span class="o">=</span><span class="n">my.at</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">my.theme</span><span class="o">$</span><span class="n">regions</span><span class="o">$</span><span class="n">col</span><span class="p">)</span>

<span class="c1">#After running this code, we should see a plot showing the mean z-scored BOLD signals for each ROI (for each state).</span>
<span class="nf">levelplot</span><span class="p">(</span><span class="nf">as.matrix</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="nf">cbind</span><span class="p">(</span><span class="n">mean1</span><span class="p">,</span><span class="n">mean2</span><span class="p">,</span><span class="n">mean3</span><span class="p">,</span><span class="n">mean4</span><span class="p">))),</span> <span class="n">par.settings</span><span class="o">=</span><span class="n">my.theme</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="n">my.at</span><span class="p">,</span> <span class="n">colorkey</span><span class="o">=</span><span class="n">my.ckey</span><span class="p">,</span>
          <span class="n">scales</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">at</span><span class="o">=</span><span class="m">1</span><span class="o">:</span><span class="n">number_regions</span><span class="p">,</span> 
                             <span class="n">labels</span><span class="o">=</span><span class="nf">row.names</span><span class="p">((</span><span class="n">mean1</span><span class="p">)))),</span> <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;ROI&quot;</span><span class="p">,</span> <span class="n">las</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;State&quot;</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&quot;Z-scored State Means&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../../images/features/notebooks/HiddenSemiMarkovModel_28_0.png"
width=420
height=420
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, let's look at the state transition probability matrix. This will show us the probability of transitioning from one state to another state, given you are about to transition.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="c1">#Let&#39;s first look at the actual probabilities.</span>
<span class="n">testrun</span><span class="o">$</span><span class="n">model</span><span class="o">$</span><span class="n">transition</span>

<span class="c1">#Now let&#39;s create a plot.</span>
<span class="n">new.palette</span><span class="o">=</span><span class="nf">colorRampPalette</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;yellow&quot;</span><span class="p">,</span><span class="s">&quot;orange&quot;</span><span class="p">,</span><span class="s">&quot;red&quot;</span><span class="p">),</span><span class="n">space</span><span class="o">=</span><span class="s">&quot;rgb&quot;</span><span class="p">)</span> 

<span class="nf">rownames</span><span class="p">(</span><span class="n">testrun</span><span class="o">$</span><span class="n">model</span><span class="o">$</span><span class="n">transition</span><span class="p">)</span><span class="o">&lt;-</span><span class="m">1</span><span class="o">:</span><span class="n">number_states</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">testrun</span><span class="o">$</span><span class="n">model</span><span class="o">$</span><span class="n">transition</span><span class="p">)</span><span class="o">&lt;-</span><span class="m">1</span><span class="o">:</span><span class="n">number_states</span>

<span class="nf">levelplot</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">testrun</span><span class="o">$</span><span class="n">model</span><span class="o">$</span><span class="n">transition</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="nf">ncol</span><span class="p">(</span><span class="n">testrun</span><span class="o">$</span><span class="n">model</span><span class="o">$</span><span class="n">transition</span><span class="p">),</span><span class="m">1</span><span class="o">:</span><span class="nf">ncol</span><span class="p">(</span><span class="n">testrun</span><span class="o">$</span><span class="n">model</span><span class="o">$</span><span class="n">transition</span><span class="p">)])),</span> <span class="n">col.regions</span><span class="o">=</span><span class="nf">new.palette</span><span class="p">(</span><span class="m">20</span><span class="p">),</span>
         <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;To&quot;</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;From&quot;</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&quot;State Transition Probability Matrix&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table>
<caption>A matrix: 4 × 4 of type dbl</caption>
<tbody>
	<tr><td>0.0000000</td><td>0.1235182</td><td>0.6336164</td><td>0.2428654</td></tr>
	<tr><td>0.1555160</td><td>0.0000000</td><td>0.7213489</td><td>0.1231350</td></tr>
	<tr><td>0.4338284</td><td>0.1785566</td><td>0.0000000</td><td>0.3876149</td></tr>
	<tr><td>0.2722770</td><td>0.1598567</td><td>0.5678663</td><td>0.0000000</td></tr>
</tbody>
</table>

</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../../images/features/notebooks/HiddenSemiMarkovModel_30_1.png"
width=420
height=420
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now, let's take a look at the sojourn time distributions for each state. Remember that the sojourn time is the number of consecutive time points you spend in a state before switching to a different state.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="c1">#Now let&#39;s plot the sojourn distribution for each state. The x-axis (i.e. &#39;u&#39;) is the sojourn time. The y-axis is the</span>
<span class="c1">#density.</span>

<span class="nf">plot</span><span class="p">(</span><span class="n">testrun</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">100</span><span class="p">),</span> <span class="n">main</span><span class="o">=</span><span class="s">&quot;State Sojourn Distributions&quot;</span><span class="p">)</span>

<span class="c1">#To get actual sojourn distribution parameter estimations, you can run the following line of code. It will give a vector</span>
<span class="c1">#estimated shape parameters and a vector of estimated scale parameters. The first number in each corresponds to the state 1</span>
<span class="c1">#estimate, the second the state 2 estimate, and so on...</span>

<span class="n">testrun</span><span class="o">$</span><span class="n">model</span><span class="o">$</span><span class="n">sojourn</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<dl>
	<dt>$shape</dt>
		<dd><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>0.613402605885514</li><li>0.230861390416741</li><li>1.55915353659582</li><li>0.687594619498318</li></ol>
</dd>
	<dt>$scale</dt>
		<dd><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>23.9088720745628</li><li>24.5487492507665</li><li>3.91149035797376</li><li>29.1435561060956</li></ol>
</dd>
	<dt>$type</dt>
		<dd>'gamma'</dd>
</dl>

</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../../images/features/notebooks/HiddenSemiMarkovModel_32_1.png"
width=420
height=420
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You may want to visualize the distance between the state correlation matrices in 2-D space. A multi-dimensional scaling plot will do this. It'll allow you to see how similar/disimilar your state correlation matrices are. If you are finding that some states appear to be overlapping, you may want to re-run your model and fit less states. In this example, we will use Euclidean distance.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">dist</span><span class="o">&lt;-</span><span class="nf">matrix</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="n">number_states</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">number_states</span><span class="p">)</span>

<span class="nf">for</span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="n">number_states</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">name1</span><span class="o">&lt;-</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;cov&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
  <span class="nf">for</span><span class="p">(</span><span class="n">j</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="n">number_states</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">name2</span><span class="o">&lt;-</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;cov&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">&lt;-</span><span class="nf">distcov</span><span class="p">(</span><span class="nf">as.matrix</span><span class="p">(</span><span class="nf">get</span><span class="p">(</span><span class="n">name1</span><span class="p">)),</span> <span class="nf">as.matrix</span><span class="p">(</span><span class="nf">get</span><span class="p">(</span><span class="n">name2</span><span class="p">)),</span> <span class="n">method</span><span class="o">=</span><span class="s">&quot;Euclidean&quot;</span><span class="p">)</span> 
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">dist</span><span class="o">&lt;-</span><span class="nf">as.data.frame</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
<span class="nf">rownames</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span><span class="o">&lt;-</span><span class="nf">as.character</span><span class="p">(</span><span class="nf">seq</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">number_states</span><span class="p">))</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span><span class="o">&lt;-</span><span class="nf">as.character</span><span class="p">(</span><span class="nf">seq</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">number_states</span><span class="p">))</span>

<span class="n">mds</span> <span class="o">&lt;-</span> <span class="nf">cmdscale</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">mds</span><span class="p">,</span> <span class="n">type</span><span class="o">=</span><span class="s">&#39;n&#39;</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&quot;Multi-dimensional Scaling&quot;</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="s">&quot; &quot;</span><span class="p">)</span>
<span class="nf">text</span><span class="p">(</span><span class="n">mds</span><span class="p">[,</span> <span class="m">1</span><span class="p">],</span> <span class="n">mds</span><span class="p">[,</span> <span class="m">2</span><span class="p">],</span> <span class="nf">labels</span><span class="p">(</span><span class="n">dist</span><span class="p">)[[</span><span class="m">1</span><span class="p">]])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../../images/features/notebooks/HiddenSemiMarkovModel_34_0.png"
width=420
height=420
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As the above plot shows, states 1 and 2 are most disimilar, where as states 1 and 4 are most similar (with regards to connectivity structure).</p>
<p>We can also look at the state sequence for each individual. The most likely state sequence, for each subject, is stored in the testrun object. Since this data consists of two parts for each subject, let's separate the results into part 1 vs. part 2.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">number_timepoints_part1</span> <span class="o">&lt;-</span> <span class="m">946</span>

<span class="n">predfun</span><span class="o">&lt;-</span><span class="nf">function</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">subject</span> <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span> <span class="n">number_timepoints_part1</span><span class="p">)</span>
  <span class="n">time</span> <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span> <span class="n">number_timepoints_part1</span><span class="p">)</span>
  <span class="n">state</span> <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span> <span class="n">number_timepoints_part1</span><span class="p">)</span>
  <span class="n">Predict</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
  
  <span class="nf">for</span><span class="p">(</span><span class="n">z</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="n">number_timepoints_part1</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">Predict</span><span class="o">$</span><span class="n">subject</span><span class="p">[</span><span class="n">z</span><span class="p">]</span><span class="o">=</span><span class="nf">floor</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="m">2</span><span class="p">)</span> <span class="o">+</span> <span class="m">1</span>
    <span class="n">Predict</span><span class="o">$</span><span class="n">time</span><span class="p">[</span><span class="n">z</span><span class="p">]</span><span class="o">=</span><span class="n">z</span>
    <span class="n">Predict</span><span class="o">$</span><span class="n">state</span><span class="p">[</span><span class="n">z</span><span class="p">]</span><span class="o">=</span><span class="n">testrun</span><span class="o">$</span><span class="n">yhat</span><span class="p">[</span><span class="n">z</span> <span class="o">+</span> <span class="nf">sum</span><span class="p">(</span><span class="n">Lengths</span><span class="p">[(</span><span class="m">1</span><span class="o">:</span><span class="p">(</span><span class="n">i</span><span class="m">-1</span><span class="p">)),])]</span>
  <span class="p">}</span>
  
  <span class="nf">return</span><span class="p">(</span><span class="n">Predict</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">Together</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="nf">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="nf">nrow</span><span class="p">(</span><span class="n">Lengths</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="m">2</span><span class="p">),</span> <span class="n">predfun</span><span class="p">)</span>
<span class="n">Predict_part1</span> <span class="o">&lt;-</span> <span class="nf">do.call</span><span class="p">(</span><span class="n">rbind</span><span class="p">,</span> <span class="n">Together</span><span class="p">)</span>
<span class="n">Predict_part1</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table>
<caption>A data.frame: 15136 × 3</caption>
<thead>
	<tr><th scope=col>subject</th><th scope=col>time</th><th scope=col>state</th></tr>
	<tr><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
	<tr><td>1</td><td> 1</td><td>3</td></tr>
	<tr><td>1</td><td> 2</td><td>3</td></tr>
	<tr><td>1</td><td> 3</td><td>3</td></tr>
	<tr><td>1</td><td> 4</td><td>3</td></tr>
	<tr><td>1</td><td> 5</td><td>3</td></tr>
	<tr><td>1</td><td> 6</td><td>3</td></tr>
	<tr><td>1</td><td> 7</td><td>4</td></tr>
	<tr><td>1</td><td> 8</td><td>4</td></tr>
	<tr><td>1</td><td> 9</td><td>3</td></tr>
	<tr><td>1</td><td>10</td><td>3</td></tr>
	<tr><td>1</td><td>11</td><td>3</td></tr>
	<tr><td>1</td><td>12</td><td>3</td></tr>
	<tr><td>1</td><td>13</td><td>1</td></tr>
	<tr><td>1</td><td>14</td><td>1</td></tr>
	<tr><td>1</td><td>15</td><td>1</td></tr>
	<tr><td>1</td><td>16</td><td>1</td></tr>
	<tr><td>1</td><td>17</td><td>1</td></tr>
	<tr><td>1</td><td>18</td><td>1</td></tr>
	<tr><td>1</td><td>19</td><td>1</td></tr>
	<tr><td>1</td><td>20</td><td>1</td></tr>
	<tr><td>1</td><td>21</td><td>4</td></tr>
	<tr><td>1</td><td>22</td><td>4</td></tr>
	<tr><td>1</td><td>23</td><td>4</td></tr>
	<tr><td>1</td><td>24</td><td>4</td></tr>
	<tr><td>1</td><td>25</td><td>2</td></tr>
	<tr><td>1</td><td>26</td><td>2</td></tr>
	<tr><td>1</td><td>27</td><td>2</td></tr>
	<tr><td>1</td><td>28</td><td>2</td></tr>
	<tr><td>1</td><td>29</td><td>2</td></tr>
	<tr><td>1</td><td>30</td><td>2</td></tr>
	<tr><td>⋮</td><td>⋮</td><td>⋮</td></tr>
	<tr><td>16</td><td>917</td><td>4</td></tr>
	<tr><td>16</td><td>918</td><td>4</td></tr>
	<tr><td>16</td><td>919</td><td>4</td></tr>
	<tr><td>16</td><td>920</td><td>4</td></tr>
	<tr><td>16</td><td>921</td><td>4</td></tr>
	<tr><td>16</td><td>922</td><td>4</td></tr>
	<tr><td>16</td><td>923</td><td>4</td></tr>
	<tr><td>16</td><td>924</td><td>4</td></tr>
	<tr><td>16</td><td>925</td><td>4</td></tr>
	<tr><td>16</td><td>926</td><td>4</td></tr>
	<tr><td>16</td><td>927</td><td>4</td></tr>
	<tr><td>16</td><td>928</td><td>4</td></tr>
	<tr><td>16</td><td>929</td><td>4</td></tr>
	<tr><td>16</td><td>930</td><td>4</td></tr>
	<tr><td>16</td><td>931</td><td>4</td></tr>
	<tr><td>16</td><td>932</td><td>4</td></tr>
	<tr><td>16</td><td>933</td><td>4</td></tr>
	<tr><td>16</td><td>934</td><td>4</td></tr>
	<tr><td>16</td><td>935</td><td>4</td></tr>
	<tr><td>16</td><td>936</td><td>4</td></tr>
	<tr><td>16</td><td>937</td><td>4</td></tr>
	<tr><td>16</td><td>938</td><td>4</td></tr>
	<tr><td>16</td><td>939</td><td>4</td></tr>
	<tr><td>16</td><td>940</td><td>4</td></tr>
	<tr><td>16</td><td>941</td><td>4</td></tr>
	<tr><td>16</td><td>942</td><td>4</td></tr>
	<tr><td>16</td><td>943</td><td>4</td></tr>
	<tr><td>16</td><td>944</td><td>4</td></tr>
	<tr><td>16</td><td>945</td><td>4</td></tr>
	<tr><td>16</td><td>946</td><td>4</td></tr>
</tbody>
</table>

</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now let's do the same for part 2, for all subjects...</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="c1">#Let&#39;s create a data frame for the state sequence for all subjects for part 2.</span>
<span class="n">number_timepoints_part2</span> <span class="o">&lt;-</span> <span class="m">1030</span>

<span class="n">predfun2</span><span class="o">&lt;-</span><span class="nf">function</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">subject</span> <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span> <span class="n">number_timepoints_part2</span><span class="p">)</span>
  <span class="n">time</span> <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span> <span class="n">number_timepoints_part2</span><span class="p">)</span>
  <span class="n">state</span> <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span> <span class="n">number_timepoints_part2</span><span class="p">)</span>
  <span class="n">Predict</span><span class="o">&lt;-</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
  
  <span class="nf">for</span><span class="p">(</span><span class="n">z</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="n">number_timepoints_part2</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">Predict</span><span class="o">$</span><span class="n">subject</span><span class="p">[</span><span class="n">z</span><span class="p">]</span><span class="o">=</span><span class="n">i</span><span class="o">/</span><span class="m">2</span>
    <span class="n">Predict</span><span class="o">$</span><span class="n">time</span><span class="p">[</span><span class="n">z</span><span class="p">]</span><span class="o">=</span><span class="n">z</span>
    <span class="n">Predict</span><span class="o">$</span><span class="n">state</span><span class="p">[</span><span class="n">z</span><span class="p">]</span><span class="o">=</span><span class="n">testrun</span><span class="o">$</span><span class="n">yhat</span><span class="p">[</span><span class="n">z</span> <span class="o">+</span> <span class="nf">sum</span><span class="p">(</span><span class="n">Lengths</span><span class="p">[(</span><span class="m">1</span><span class="o">:</span><span class="p">(</span><span class="n">i</span><span class="m">-1</span><span class="p">)),])]</span>
  <span class="p">}</span>
  
  <span class="nf">return</span><span class="p">(</span><span class="n">Predict</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">Together2</span><span class="o">&lt;-</span><span class="nf">lapply</span><span class="p">(</span><span class="nf">seq</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="nf">nrow</span><span class="p">(</span><span class="n">Lengths</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="m">2</span><span class="p">),</span> <span class="n">predfun2</span><span class="p">)</span>
<span class="n">Predict_part2</span><span class="o">&lt;-</span><span class="nf">do.call</span><span class="p">(</span><span class="n">rbind</span><span class="p">,</span> <span class="n">Together2</span><span class="p">)</span>
<span class="n">Predict_part2</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table>
<caption>A data.frame: 16480 × 3</caption>
<thead>
	<tr><th scope=col>subject</th><th scope=col>time</th><th scope=col>state</th></tr>
	<tr><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
	<tr><td>1</td><td> 1</td><td>3</td></tr>
	<tr><td>1</td><td> 2</td><td>3</td></tr>
	<tr><td>1</td><td> 3</td><td>3</td></tr>
	<tr><td>1</td><td> 4</td><td>3</td></tr>
	<tr><td>1</td><td> 5</td><td>3</td></tr>
	<tr><td>1</td><td> 6</td><td>3</td></tr>
	<tr><td>1</td><td> 7</td><td>4</td></tr>
	<tr><td>1</td><td> 8</td><td>4</td></tr>
	<tr><td>1</td><td> 9</td><td>3</td></tr>
	<tr><td>1</td><td>10</td><td>3</td></tr>
	<tr><td>1</td><td>11</td><td>3</td></tr>
	<tr><td>1</td><td>12</td><td>3</td></tr>
	<tr><td>1</td><td>13</td><td>1</td></tr>
	<tr><td>1</td><td>14</td><td>1</td></tr>
	<tr><td>1</td><td>15</td><td>1</td></tr>
	<tr><td>1</td><td>16</td><td>1</td></tr>
	<tr><td>1</td><td>17</td><td>1</td></tr>
	<tr><td>1</td><td>18</td><td>1</td></tr>
	<tr><td>1</td><td>19</td><td>1</td></tr>
	<tr><td>1</td><td>20</td><td>1</td></tr>
	<tr><td>1</td><td>21</td><td>4</td></tr>
	<tr><td>1</td><td>22</td><td>4</td></tr>
	<tr><td>1</td><td>23</td><td>4</td></tr>
	<tr><td>1</td><td>24</td><td>4</td></tr>
	<tr><td>1</td><td>25</td><td>2</td></tr>
	<tr><td>1</td><td>26</td><td>2</td></tr>
	<tr><td>1</td><td>27</td><td>2</td></tr>
	<tr><td>1</td><td>28</td><td>2</td></tr>
	<tr><td>1</td><td>29</td><td>2</td></tr>
	<tr><td>1</td><td>30</td><td>2</td></tr>
	<tr><td>⋮</td><td>⋮</td><td>⋮</td></tr>
	<tr><td>16</td><td>1001</td><td>4</td></tr>
	<tr><td>16</td><td>1002</td><td>4</td></tr>
	<tr><td>16</td><td>1003</td><td>4</td></tr>
	<tr><td>16</td><td>1004</td><td>4</td></tr>
	<tr><td>16</td><td>1005</td><td>4</td></tr>
	<tr><td>16</td><td>1006</td><td>4</td></tr>
	<tr><td>16</td><td>1007</td><td>4</td></tr>
	<tr><td>16</td><td>1008</td><td>4</td></tr>
	<tr><td>16</td><td>1009</td><td>4</td></tr>
	<tr><td>16</td><td>1010</td><td>4</td></tr>
	<tr><td>16</td><td>1011</td><td>4</td></tr>
	<tr><td>16</td><td>1012</td><td>4</td></tr>
	<tr><td>16</td><td>1013</td><td>4</td></tr>
	<tr><td>16</td><td>1014</td><td>4</td></tr>
	<tr><td>16</td><td>1015</td><td>4</td></tr>
	<tr><td>16</td><td>1016</td><td>4</td></tr>
	<tr><td>16</td><td>1017</td><td>4</td></tr>
	<tr><td>16</td><td>1018</td><td>4</td></tr>
	<tr><td>16</td><td>1019</td><td>4</td></tr>
	<tr><td>16</td><td>1020</td><td>3</td></tr>
	<tr><td>16</td><td>1021</td><td>3</td></tr>
	<tr><td>16</td><td>1022</td><td>3</td></tr>
	<tr><td>16</td><td>1023</td><td>3</td></tr>
	<tr><td>16</td><td>1024</td><td>3</td></tr>
	<tr><td>16</td><td>1025</td><td>4</td></tr>
	<tr><td>16</td><td>1026</td><td>4</td></tr>
	<tr><td>16</td><td>1027</td><td>4</td></tr>
	<tr><td>16</td><td>1028</td><td>4</td></tr>
	<tr><td>16</td><td>1029</td><td>4</td></tr>
	<tr><td>16</td><td>1030</td><td>4</td></tr>
</tbody>
</table>

</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now you have the state information for each subject in a data frame. If you want, you can make visual summaries of the state dynamics.</p>
<p>Let's plot Part 1 first.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">forheat</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="n">Predict_part1</span><span class="p">[,</span><span class="m">3</span><span class="p">],</span> <span class="n">nrow</span><span class="o">=</span><span class="n">number_timepoints_part1</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="m">16</span><span class="p">,</span> <span class="n">byrow</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
<span class="n">forheat2</span> <span class="o">&lt;-</span> <span class="nf">t</span><span class="p">(</span><span class="n">forheat</span><span class="p">)</span>

<span class="nf">heatmap.2</span><span class="p">(</span><span class="n">forheat2</span><span class="p">,</span>  <span class="c1"># same data set for cell labels</span>
          <span class="n">main</span><span class="o">=</span><span class="s">&quot;States Over Time - Part 1&quot;</span><span class="p">,</span>
          <span class="n">Rowv</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">16</span><span class="p">),</span>
          <span class="n">notecol</span><span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">,</span>      <span class="c1"># change font color of cell labels to black</span>
          <span class="n">density.info</span><span class="o">=</span><span class="s">&quot;none&quot;</span><span class="p">,</span>  <span class="c1"># turns off density plot inside color legend</span>
          <span class="n">trace</span><span class="o">=</span><span class="s">&quot;none&quot;</span><span class="p">,</span>     <span class="c1"># widens margins around plot</span>
          <span class="n">col</span><span class="o">=</span><span class="nf">rev</span><span class="p">(</span><span class="nf">rainbow</span><span class="p">(</span><span class="m">4</span><span class="p">)),</span>    <span class="c1"># enable color transition at specified limits</span>
          <span class="n">dendrogram</span><span class="o">=</span><span class="s">&quot;none&quot;</span><span class="p">,</span>     <span class="c1"># only draw a row dendrogram</span>
          <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;Subject ID&quot;</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;Time&quot;</span><span class="p">,</span>
          <span class="n">Colv</span><span class="o">=</span><span class="s">&quot;NA&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">keysize</span> <span class="o">=</span> <span class="m">1.5</span><span class="p">,</span> <span class="n">cexRow</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span> <span class="n">cexCol</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../../images/features/notebooks/HiddenSemiMarkovModel_40_0.png"
width=420
height=420
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now, let's plot Part 2.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">forheat</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="n">Predict_part2</span><span class="p">[,</span><span class="m">3</span><span class="p">],</span> <span class="n">nrow</span><span class="o">=</span><span class="n">number_timepoints_part2</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="m">16</span><span class="p">,</span> <span class="n">byrow</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
<span class="n">forheat2</span> <span class="o">&lt;-</span> <span class="nf">t</span><span class="p">(</span><span class="n">forheat</span><span class="p">)</span>

<span class="nf">heatmap.2</span><span class="p">(</span><span class="n">forheat2</span><span class="p">,</span>  <span class="c1"># same data set for cell labels</span>
          <span class="n">main</span><span class="o">=</span><span class="s">&quot;States Over Time - Part 2&quot;</span><span class="p">,</span>
          <span class="n">Rowv</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">16</span><span class="p">),</span>
          <span class="n">notecol</span><span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">,</span>      <span class="c1"># change font color of cell labels to black</span>
          <span class="n">density.info</span><span class="o">=</span><span class="s">&quot;none&quot;</span><span class="p">,</span>  <span class="c1"># turns off density plot inside color legend</span>
          <span class="n">trace</span><span class="o">=</span><span class="s">&quot;none&quot;</span><span class="p">,</span>     <span class="c1"># widens margins around plot</span>
          <span class="n">col</span><span class="o">=</span><span class="nf">rev</span><span class="p">(</span><span class="nf">rainbow</span><span class="p">(</span><span class="m">4</span><span class="p">)),</span>    <span class="c1"># enable color transition at specified limits</span>
          <span class="n">dendrogram</span><span class="o">=</span><span class="s">&quot;none&quot;</span><span class="p">,</span>     <span class="c1"># only draw a row dendrogram</span>
          <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;Subject ID&quot;</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;Time&quot;</span><span class="p">,</span>
          <span class="n">Colv</span><span class="o">=</span><span class="s">&quot;NA&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">keysize</span> <span class="o">=</span> <span class="m">1.5</span><span class="p">,</span> <span class="n">cexRow</span><span class="o">=</span><span class="m">1.5</span><span class="p">,</span> <span class="n">cexCol</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../../images/features/notebooks/HiddenSemiMarkovModel_42_0.png"
width=420
height=420
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Wrapping-Up">Wrapping Up<a class="anchor-link" href="#Wrapping-Up"> </a></h1>
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The above code is just a sample of what you can do in R to fit the HSMMs to your data! We have presented the basics, but there is so much more to these analyses, such as conducting permutation tests to compare groups on sojourn times, state dwell times, transition probabilities, etc. We are also working on a covariate implementation of the HSMM, where the model allows for covariates to predict sojourn times! Stay tuned for some exciting developments in the near future!</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Recommended-Reading">Recommended Reading<a class="anchor-link" href="#Recommended-Reading"> </a></h1><ul>
<li>Shappell H, Caffo BS, Pekar JJ, Lindquist MA. Improved state change estimation in dynamic functional connectivity using hidden semi-Markov models. Neuroimage. 2019;191:243‐257. doi:10.1016/j.neuroimage.2019.02.013.</li>
</ul>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Contributions">Contributions<a class="anchor-link" href="#Contributions"> </a></h1><p>Tutorial written by Heather Shappell. Text and code edited by Luke Chang.</p>

</div>
</div>
</div>
</div>

 


    </main>
    